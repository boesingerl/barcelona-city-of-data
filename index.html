<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="index_files/favicon.ico">

  <title>Project Zozo</title>


  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
  <!-- Bootstrap core CSS -->
  <link href="./index_files/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="./index_files/jumbotron.css" rel="stylesheet">
  <script src="./index_files/lodash.js"></script>
  <script src="./index_files/d3.js"></script>

  <script data-dapp-detection="">
    (function() {
      let e = !1;

      function n() {
        if (!e) {
          const n = document.createElement("meta");
          n.name = "dapp-detected", document.head.appendChild(n), e = !0
        }
      }
      if (window.hasOwnProperty("ethereum")) {
        if (window.__disableDappDetectionInsertion = !0, void 0 === window.ethereum) return;
        n()
      } else {
        var t = window.ethereum;
        Object.defineProperty(window, "ethereum", {
          configurable: !0,
          set: function(e) {
            window.__disableDappDetectionInsertion || n(), t = e
          },
          get: function() {
            return window.__disableDappDetectionInsertion || n(), t
          }
        })
      }
    })();
  </script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <link rel="stylesheet" href="index_files/rSlider.min.css">
  <script src="index_files/rSlider.min.js"></script>
</head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />

<style>
  .popout-video {
    width: 50%;
    position: relative;
  }

  .popout-video--popout {
    border-radius: 25px;
    position: fixed;
    left: 0;
    top: 100;
    width: 200px;
    max-width: 50%;
    height: auto;
    -webkit-animation: popin 0.5s ease-in-out forwards;
    animation: popin 0.5s ease-in-out forwards;
  }

  @-webkit-keyframes popin {
    to {
      top: 30%;
    }
  }

  @keyframes popin {
    to {
      top: 30%;
    }
  }

  .popout-video--popout:hover .popout-video__controls {
    opacity: 1;
  }

  .popout-video video {
    width: 50%;
    vertical-align: middle;
  }

  .popout-video__controls {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    padding: 0.5rem;
    background: black;
    background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, black 100%);
    z-index: 1;
    display: flex;
    justify-content: flex-end;
    opacity: 0;
    transition: opacity 0.25s ease;
    pointer-events: none;
  }

  .popout-video__controls .close-video {
    width: 1.77rem;
    height: 1.7rem;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: all;
    border-radius: 50%;
    transition: background 0.25s ease;
  }

  .popout-video__controls .close-video:hover {
    background: rgba(50, 50, 50, 0.4);
  }

  .popout-video__controls .close-video:before,
  .popout-video__controls .close-video:after {
    content: "";
    position: absolute;
    margin: auto;
    width: 1rem;
    height: 2px;
    background: #fff;
  }

  .popout-video__controls .close-video:before {
    transform: rotate(45deg);
  }

  .popout-video__controls .close-video:after {
    transform: rotate(-45deg);
  }

  .mapleftmargin {
    position: relative;
    left: 0;
    top: 100;
    -webkit-animation: poping 0.5s ease-in-out forwards;

  }

  .mapleftmarginundo {
    position: relative;
    left: 0;
    top: 100;
    -webkit-animation: popingup 0.5s ease-in-out forwards;

  }

  @-webkit-keyframes poping {
    from{
      left:0px
    }
    to {
      left: 300px;
    }
  }

  @-webkit-keyframes popingup {
    from{
      left:300px
    }
    to {
      left: 0px;
    }
  }


  #mapid{
    border-radius:10px;
  }

  .mytooltip {
  box-shadow: none;
  background: transparent;
  border: 0px
}

</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const introContainer = document.querySelector('.intro');
    const videoContainer = document.querySelector('.popout-video');
    const video = videoContainer.querySelector('#mapid');
    const graphContainer = document.querySelector('#graphContainer')
    let videoHeight = videoContainer.offsetHeight;

    const closeVideoBtn = document.querySelector('.close-video');

    let popOut = true;
    let ignoreThis = true;

    introContainer.style.height = `${videoHeight}px`;
    //graphContainer.classList.add('mapleftmargin');

    window.addEventListener('scroll', function(e) {
      if (window.scrollY > videoHeight + 200) {
        // only pop out the video if it wasnt closed before
        if (popOut) {
          console.log('moving')
          graphContainer.classList.remove('mapleftmarginundo');
          graphContainer.classList.add('mapleftmargin');

          videoContainer.classList.add('popout-video--popout');
          // set video container off the screen for the slide in animation
          videoContainer.style.top = `-${videoHeight}px`;
          ignoreThis = false;
        }
      } else {
        graphContainer.classList.remove('mapleftmargin');
        if(!ignoreThis){
          graphContainer.classList.add('mapleftmarginundo');
        }
        videoContainer.classList.remove('popout-video--popout');
        videoContainer.style.top = `0px`;
        popOut = true;
      }
    });

    // close the video and prevent from opening again on scrolling + pause the video
    /*closeVideoBtn.addEventListener('click', function() {
    	videoContainer.classList.remove('popout-video--popout');
    	video.pause();
    	popOut = false;
    });*/

    window.addEventListener('resize', function() {
      videoHeight = videoContainer.offsetHeight;
      introContainer.style.height = `${videoHeight}px`;
    });
  });
</script>

<body>
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <a class="navbar-brand" href="./">Project Zozo : A Barcelona Visualization</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="./">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="pages/choropleth.html">Choropleth and Cartogram</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="pages/districts.html">District comparison</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="pages/about.html">About us</a>
        </li>

      </ul>
    </div>
  </nav>

  <main role="main">

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container d-flex justify-content-center pb-5">
        <div>
          <h1>Overall and Per-District statistics </h1>
          <h3>Click on a district to see statistics about it ! </h3>
        </div>
      </div>


      <div class="container d-flex justify-content-center">
        <div class="intro">
          <div class="popout-video">
            <div id="mapid" style="width:600px; height:400px"></div>
          </div>
        </div>

        <script>
          var bounds = L.latLngBounds(L.latLng(41.47308784765205, 2.365493774414063), L.latLng(41.26696898724201, 1.953506497265627))
          var mymap = L.map('mapid', {
            maxBounds: bounds
          }).setView([41.37, 2.1592], 11);

          L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            minZoom: 11,
            id: 'mapbox/light-v10',
            tileSize: 512,
            zoomOffset: -1
          }).addTo(mymap);

          let districts = {
            'Nou Barris': 'nou-barris.json',
            'Eixample': 'eixample.json',
            'Ciutat Vella': 'ciutat-vella.json',
            'Gràcia': 'gracia.json',
            'Sant Martí': 'sant-marti.json',
            'Sant Andreu': 'sant-andreu.json',
            'Les Corts': 'les-corts.json',
            'Horta-Guinardó': 'horta-guinardo.json',
            'Sarrià-Sant Gervasi': 'sarria-sant-gervasi.json',
            'Sants-Montjuïc': 'sants-montjuic.json',
          }

          mymap.on('drag', function() {
            mymap.panInsideBounds(bounds, {
              animate: false
            });
          });

          mymap.getRenderer(mymap).options.padding = 0.5;


          let load_poly = async (name, filename, polygons) => {
            let coords = await fetch(`polygons/${filename}`).then(res => res.json()).then(json => json['geometry'])
            let polygon = L.geoJSON(coords).addTo(mymap);
            polygons[name] = polygon;
          }


          let f = async function() {
            let polygons = {};
            for (const [name, filename] of Object.entries(districts)) {
              await load_poly(name, filename, polygons);
            }
            return polygons;
          };

          var poly = f()

          poly.then(polygons => {
            for (const [district, polygon] of Object.entries(polygons)) {
              polygon.on('click', () => update(district))
              polygon.bindTooltip(district, {permanent:false, direction:"center"});
            }
          })

        </script>
      </div>
    </div>

    
    

    <div id='graphContainer' class="container">
      
      <!-- Example row of columns -->
      <div class="container d-flex justify-content-center p-5">
        <h1 id='selectionText'>Currently showing : Overall</h1>
      </div>

      <div class="d-flex justify-content-center p-4">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault">
          <label class="form-check-label" for="flexSwitchCheckDefault">Y-axis starting from zero</label>
        </div>
      </div>

      <div class="row">
        <div class="col-sm">
          <h5 class="text-center">Population over time</h5>
          <div id="graphPop"></div>
        </div>
        <div class="col-sm">
          <h5 class="text-center">Births over time</h5>
          <div id="graphBirth"></div>
        </div>
        <div class="col-sm">
          <h5 class="text-center">Deaths over time</h5>
          <div id="graphDeath"></div>
        </div>
      </div>

      <div class="row">
        <div class="col-sm">
          <h5 class="text-center">Unemployment over time</h5>
          <div id="graphUnemployment"></div>
        </div>
        <div class="col-sm">
          <h5 class="text-center">Immigrants over time</h5>
          <div id="graphImmigrants"></div>
        </div>
        <div class="col-sm">
          <h5 class="text-center">Population per gender</h5>
          <div id="graphPopGender"></div>
        </div>
      </div>

      <div class="row">
        <div class="col-sm">
          <h5 class="text-center">Population age</h5>
          <div id="graphPopAge"></div>
        </div>
        <div class="col-sm">
          <h5 class="text-center">Death age</h5>
          <div id="graphDeathAge"></div>
        </div>
        <div class="col-sm">
          <h5 class="text-center">Immigrants by age</h5>
          <div id="graphImmigrantAge"></div>
        </div>
      </div>


    </div> <!-- /container -->



  </main>

  <footer class="container">
    <p>© Project Zozo 2021</p>
  </footer>

  <!-- Bootstrap core JavaScript
    ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="./index_files/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script>
    window.jQuery || document.write('<script src="../../assets/js/vendor/jquery-slim.min.js"><\/script>')
  </script>
  <script src="./index_files/popper.min.js"></script>
  <script src="./index_files/bootstrap.min.js"></script>
  <script src="./graph.js"></script>
  <script>
    const colors = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"]

    function getNewColor() {
      let i = -1
      return () => {
        i += 1;
        return colors[i % 10]
      }
    }

    let changingColor = getNewColor()
    
    const graphPop = new HistGraph("data/population.csv", "graphPop", {
      "color": changingColor()
    })
    const graphBirth = new HistGraph("data/births.csv", "graphBirth", {
      "color": changingColor()
    })
    const graphDeath = new HistGraph("data/deaths.csv", "graphDeath", {
      "color": changingColor()
    })

    const graphUnemployment = new HistGraph("data/unemployment.csv", "graphUnemployment", {
      "color": changingColor()
    })
    const graphImmigrants = new HistGraph("data/immigrants_by_nationality.csv", "graphImmigrants", {
      "color": changingColor()
    })
    const graphPopGender = new HistGraph("data/population.csv", "graphPopGender", {
      "yearFeature": "Gender",
      "color": changingColor()
    })

    const graphPopAge = new HistGraph("data/population.csv", "graphPopAge", {
      "yearFeature": "Age",
      "color": changingColor()
    })
    const graphDeathAge = new HistGraph("data/deaths.csv", "graphDeathAge", {
      "yearFeature": "Age",
      "color": changingColor()
    })
    
    const graphImmigrantAge = new HistGraph("data/immigrants_emigrants_by_age.csv", "graphImmigrantAge", {
      "yearFeature": "Age",
      "color": changingColor(),
      "mainFeature":"Immigrants"
    })

    const allGraphs = [graphPop, graphBirth, graphDeath, graphUnemployment, graphImmigrants, graphPopGender, graphPopAge, graphDeathAge, graphImmigrantAge]
    
    function update(district) {
      d3.select('#selectionText').text(`Currently showing ${district}`)
      allGraphs.map(x => x.update(district))
      poly.then(pol => {
        
        Object.values(pol).forEach(p => p.setStyle({fillColor:'#3388ff'}))
        
        pol[district].setStyle({
        fillColor: "aquamarine"
      })})
    }

    $('#flexSwitchCheckDefault').change(function() {
      allGraphs.map(x => x.updateYAxis(this.checked)) 
    });

  </script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>

</body>

</html>
